"""Build a CFD JSON table from the FractionActive_dlfc_lookup-style table.

This script contains the raw table (pasted) and produces
`crispr_check/data/cfd_published.json` with keys `pos_weights` and `sub_weights`.

Positional weights are derived from mean(1 - PercentActive) per position,
scaled so the maximum positional weight is 0.12 (matches earlier placeholder magnitudes).
Substitution weights are mean(1 - PercentActive) across positions for that substitution.
"""
from pathlib import Path
import json

RAW = '''
rA:dG 1 0.15080407 0.82158694 0.57105504 0.85714286 14
rA:dG 2 0.08256253 1.08321699 0.86981982 0.78571429 14
rA:dG 3 0.00048865 3.31099838 2.86840607 0.42857143 14
rA:dG 4 5.29E-05 4.27673116 2.76736368 0.35294118 17
rA:dG 5 0.0042093 2.37579024 2.02956098 0.5 14
rA:dG 6 8.19E-05 4.08678804 2.44022294 0.45454545 22
rA:dG 7 0.00012376 3.90741024 2.23101806 0.4375 16
rA:dG 8 0.00013274 3.87700948 2.78971802 0.42857143 14
rA:dG 9 0.00351737 2.45378213 1.87966561 0.57142857 14
rA:dG 10 0.00012466 3.90428023 2.505057 0.33333333 15
rA:dG 11 0.00085583 3.06761068 2.18324021 0.4 15
rA:dG 12 2.60E-07 6.58570748 3.09138351 0.26315789 19
rA:dG 13 3.93E-07 6.40555373 3.5052028 0.21052632 19
rA:dG 14 5.66E-06 5.24731523 3.22161318 0.21428571 14
rA:dG 15 0.00119017 2.92439231 2.87951775 0.27272727 11
rA:dG 16 9.19E-12 11.0365568 4.2960168 0 15
rA:dG 17 1.08E-05 4.96741742 3.06713566 0.17647059 17
rA:dG 18 5.93E-09 8.22728982 3.34015608 0.19047619 21
rA:dG 19 1.28E-11 10.8924187 3.80125214 0.20689655 29
rA:dG 20 4.60E-08 7.3367926 3.63779897 0.22727273 22
rA:dC 1 0.03710542 1.4305626 0.0505138 1 23
rA:dC 2 0.01955361 1.70877311 0.75225745 0.8 25
rA:dC 3 0.00755541 2.12174188 1.51548934 0.61111111 18
rA:dC 4 0.00936105 2.02867559 1.66814843 0.625 16
rA:dC 5 0.00443569 2.35303914 1.41545487 0.72 25
rA:dC 6 0.02408143 1.61831775 1.23028466 0.71428571 14
rA:dC 7 0.01298248 1.88664229 1.66808979 0.70588235 17
rA:dC 8 0.03946754 1.40375999 1.08065883 0.73333333 15
rA:dC 9 0.00678875 2.16821028 1.52340745 0.66666667 21
rA:dC 10 0.00072062 3.14229287 1.8601521 0.55555556 18
rA:dC 11 0.00117075 2.93153646 1.7511955 0.65 20
rA:dC 12 0.00595298 2.22526558 1.35571705 0.72222222 18
rA:dC 13 0.0005794 3.23702295 1.81180047 0.65217391 23
rA:dC 14 0.00070454 3.1520934 2.26453522 0.46666667 15
rA:dC 15 0.00868062 2.06144926 1.18146232 0.65 20
rA:dC 16 1.24E-09 8.90583382 3.08566311 0.19230769 26
rA:dC 17 4.94E-07 6.30656626 3.22938127 0.17647059 17
rA:dC 18 0.00019048 3.72015241 2.67471376 0.4 15
rA:dC 19 0.00014365 3.84268923 2.54688917 0.375 16
rA:dC 20 0.00947503 2.02341959 1.42872887 0.76470588 17
rA:dA 1 0.0090654 2.04261321 -0.0059174 1 18
rA:dA 2 0.09260833 1.03334994 0.90486647 0.72727273 11
rA:dA 3 0.00935729 2.02885005 1.32819923 0.70588235 17
rA:dA 4 0.04392516 1.3572866 1.06531571 0.63636364 11
rA:dA 5 0.00098127 3.00821037 2.46861822 0.36363636 11
rA:dA 6 0.01322677 1.87854633 1.47753044 0.71428571 14
rA:dA 7 0.00095579 3.01963528 2.2324425 0.4375 16
rA:dA 8 0.00065315 3.18498461 3.00116123 0.42857143 14
rA:dA 9 0.00632219 2.19913263 1.83779959 0.6 15
rA:dA 10 0.04231777 1.37347726 0.623905 0.88235294 17
rA:dA 11 0.00124996 2.90310448 3.01043421 0.30769231 13
rA:dA 12 0.00048674 3.31270307 3.01715185 0.33333333 12
rA:dA 13 0.00120468 2.9191278 3.22281835 0.3 10
rA:dA 14 0.00042808 3.36846999 2.06519687 0.53333333 15
rA:dA 15 8.24E-07 6.0840763 3.52339055 0.2 15
rA:dA 16 1.59E-10 9.79948749 4.01227372 0 13
rA:dA 17 1.45E-07 6.83780412 3.20816743 0.13333333 15
rA:dA 18 0.00134866 2.87009856 2.05252386 0.5 16
rA:dA 19 0.00248525 2.60463059 1.39236434 0.53846154 13
rA:dA 20 0.0363493 1.43950399 1.51204136 0.6 10
rC:dT 1 0.48874344 0.31091906 0.22843486 1 10
rC:dT 2 0.02739062 1.56239812 1.2701663 0.72727273 11
rC:dT 3 0.03087654 1.5103714 0.86956611 0.86666667 15
rC:dT 4 0.03162251 1.50000373 0.80257625 0.84210526 19
rC:dT 5 0.00486629 2.31280164 1.87011733 0.57142857 14
rC:dT 6 0.072446 1.13998558 0.58618602 0.92857143 14
rC:dT 7 0.02220071 1.65363312 1.0561785 0.75 16
rC:dT 8 0.00237246 2.62480201 1.57443461 0.65 20
rC:dT 9 0.03133202 1.50401154 1.09032998 0.85714286 14
rC:dT 10 0.12239325 0.91224253 0.65818595 0.86666667 15
rC:dT 11 0.01290975 1.88908209 1.33731973 0.75 16
rC:dT 12 0.01060136 1.9746383 1.14158271 0.71428571 14
rC:dT 13 0.00021995 3.65768339 2.3594679 0.38461538 13
rC:dT 14 3.26E-06 5.48665498 3.08270436 0.35 20
rC:dT 15 2.66E-06 5.57533596 3.33856972 0.22222222 18
rC:dT 16 0.1506935 0.82190548 0.51466348 1 10
rC:dT 17 0.0007477 3.12627249 2.12885402 0.46666667 15
rC:dT 18 0.00541736 2.26621216 1.41979601 0.53846154 13
rC:dT 19 0.01323038 1.87842756 3.10920602 0.42857143 7
rC:dT 20 0.00018696 3.72824694 2.12119061 0.5 16
rC:dC 1 0.47693235 0.32154322 0.22233104 0.91304348 23
rC:dC 2 0.01244395 1.90504169 1.15569348 0.69565217 23
rC:dC 3 0.00143188 2.84409231 2.11576695 0.5 18
rC:dC 4 0.0009404 3.02668869 2.32632163 0.5 16
rC:dC 5 0.0003175 3.49825126 1.94838234 0.6 25
rC:dC 6 0.00396937 2.40127795 1.82290978 0.5 14
rC:dC 7 0.00069882 3.15563761 2.10334887 0.47058824 17
rC:dC 8 0.00956815 2.01917197 1.56591527 0.64285714 14
rC:dC 9 0.00658664 2.18133624 1.35901762 0.61904762 21
rC:dC 10 1.89E-05 4.72405373 2.93336489 0.38888889 18
rC:dC 11 2.53E-07 6.59745417 3.33269291 0.25 20
rC:dC 12 0.00034794 3.45850073 2.11608454 0.44444444 18
rC:dC 13 2.89E-10 9.53858858 3.51790148 0.13636364 22
rC:dC 14 8.88E-11 10.0516867 4.45351133 0 15
rC:dC 15 8.16E-12 11.0885295 4.47243837 0.05 20
rC:dC 16 1.76E-11 10.7550697 3.46809157 0.15384615 26
rC:dC 17 1.89E-10 9.72386715 4.03030342 0.05882353 17
rC:dC 18 1.69E-07 6.77151538 3.95353889 0.13333333 15
rC:dC 19 1.30E-07 6.88681094 3.94961271 0.125 16
rC:dC 20 3.47E-09 8.45948655 4.19713088 0.05882353 17
rC:dA 1 0.17392965 0.75962637 0.13093174 1 17
rC:dA 2 0.42097375 0.37574498 0.18191949 0.90909091 11
rC:dA 3 0.05940696 1.22616264 0.8786905 0.6875 16
rC:dA 4 0.06112851 1.21375618 0.57687526 0.8 10
rC:dA 5 0.02363687 1.62641001 1.59541578 0.63636364 11
rC:dA 6 0.04819204 1.3170247 0.50029294 0.92857143 14
rC:dA 7 0.09431636 1.02541299 0.85578598 0.8125 16
rC:dA 8 0.06828572 1.16567011 0.62445733 0.875 16
rC:dA 9 0.06799352 1.16753244 0.80244985 0.875 16
rC:dA 10 0.35617095 0.4483415 0.28778777 0.94117647 17
rC:dA 11 0.0003828 3.41702832 2.81788938 0.30769231 13
rC:dA 12 0.00232069 2.6343831 2.39410529 0.53846154 13
rC:dA 13 0.05347381 1.27185887 1.31778127 0.7 10
rC:dA 14 0.00968158 2.01405385 1.56055607 0.73333333 15
rC:dA 15 6.16E-08 7.2105949 3.73400195 0.06666667 15
rC:dA 16 1.71E-05 4.76631878 2.9326739 0.30769231 13
rC:dA 17 0.00110906 2.95504545 2.11426233 0.46666667 15
rC:dA 18 0.01301864 1.88543438 1.59790361 0.64285714 14
rC:dA 19 0.00096944 3.01348013 2.00483942 0.46153846 13
rC:dA 20 0.00034675 3.45998904 2.68634493 0.3 10
rG:dT 1 0.34347729 0.46410197 0.32657368 0.9 10
rG:dT 2 0.27157397 0.56611186 0.44709679 0.84615385 13
rG:dT 3 0.02108296 1.67606834 1.07625692 0.75 16
rG:dT 4 0.21299821 0.67162404 0.38034259 0.9 20
rG:dT 5 0.03372531 1.47204408 0.82086241 0.86666667 15
rG:dT 6 0.22651801 0.64489727 0.3753578 1 11
rG:dT 7 0.49643972 0.30413348 0.23426912 1 15
rG:dT 8 0.36963733 0.43222418 0.2795809 1 20
rG:dT 9 0.00257137 2.58983519 1.40128012 0.64285714 14
rG:dT 10 0.492024 0.30801371 0.2285593 0.93333333 15
rG:dT 11 0.19735518 0.70475147 0.13534255 1 14
rG:dT 12 0.07718819 1.11244916 0.71138873 0.93333333 15
rG:dT 13 0.18687647 0.72844538 0.50391231 0.92307692 13
rG:dT 14 0.01643127 1.78432878 1.32626793 0.75 20
rG:dT 15 0.01214279 1.91568142 0.71268727 0.94117647 17
rG:dT 16 0.07993978 1.09723705 0.58347424 1 10
rG:dT 17 0.03189912 1.49622126 0.62193648 0.93333333 15
rG:dT 18 0.01631709 1.78735741 1.54012986 0.69230769 13
rG:dT 19 0.03566699 1.44773352 1.84712625 0.71428571 7
rG:dT 20 0.34747253 0.45907952 0.14738973 0.9375 16
rG:dG 1 0.02145773 1.66841613 1.07662988 0.71428571 14
rG:dG 2 0.02483709 1.60489931 1.25279683 0.69230769 13
rG:dG 3 0.00110128 2.95810261 2.23839243 0.38461538 13
rG:dG 4 0.0005614 3.25072601 2.06201117 0.52941176 17
rG:dG 5 0.07419882 1.12960302 0.75595049 0.78571429 14
rG:dG 6 0.00513646 2.28933633 1.53732259 0.68181818 22
rG:dG 7 0.00547697 2.26145964 1.56270853 0.6875 16
rG:dG 8 0.00927646 2.03261761 1.81416058 0.61538462 13
rG:dG 9 0.00288845 2.53933553 2.43821767 0.53846154 13
rG:dG 10 0.00012442 3.90512625 2.36874615 0.4 15
rG:dG 11 0.00093508 3.02915202 1.93801943 0.42857143 14
rG:dG 12 0.00134624 2.87087732 1.52862736 0.52941176 17
rG:dG 13 0.00057522 3.24016299 2.02573383 0.42105263 19
rG:dG 14 0.00035249 3.45285123 2.47466781 0.42857143 14
rG:dG 15 0.00153152 2.81487841 3.19191431 0.27272727 11
rG:dG 16 2.80E-08 7.55255979 4.38668382 0 15
rG:dG 17 2.78E-07 6.55573997 2.92358739 0.23529412 17
rG:dG 18 0.000103 3.9871826 2.21246721 0.47619048 21
rG:dG 19 1.20E-06 5.91914275 2.37811275 0.44827586 29
rG:dG 20 1.58E-05 4.80019318 2.20549212 0.42857143 21
rG:dA 1 0.01571868 1.8035838 0.03077673 1 17
rG:dA 2 0.15290615 0.81557504 0.77139784 0.63636364 11
rG:dA 3 0.00030417 3.51688019 2.04335773 0.5 16
rG:dA 4 0.00328068 2.48403649 2.73456211 0.36363636 11
rG:dA 5 0.00167082 2.77707046 2.87716629 0.3 10
rG:dA 6 0.0081182 2.09054008 1.56499886 0.66666667 12
rG:dA 7 0.0109494 1.96060962 1.77101436 0.57142857 14
rG:dA 8 0.00231652 2.63516354 2.29429544 0.625 16
rG:dA 9 0.00541697 2.26624358 1.81475563 0.53333333 15
rG:dA 10 0.01185621 1.92605408 0.75065859 0.8125 16
rG:dA 11 0.0006346 3.19749827 2.42742215 0.38461538 13
rG:dA 12 0.0013692 2.8635316 2.61812148 0.38461538 13
rG:dA 13 0.00042404 3.37258927 3.00370944 0.3 10
rG:dA 14 3.47E-05 4.45916931 3.12547668 0.26666667 15
rG:dA 15 4.21E-07 6.37579768 3.49937656 0.14285714 14
rG:dA 16 3.40E-08 7.46904547 4.80779457 0 13
rG:dA 17 2.31E-05 4.63589906 2.84991517 0.25 16
rG:dA 18 0.00770354 2.11330942 1.51604328 0.66666667 15
rG:dA 19 0.01702428 1.76893123 1.51448938 0.66666667 12
rG:dA 20 0.19215458 0.71634927 0.58638105 0.7 10
rU:dT 1 0.44243651 0.35414904 0.25537166 1 9
rU:dT 2 0.136875 0.86367586 0.72454308 0.84615385 13
rU:dT 3 0.03318192 1.47909847 0.98572229 0.71428571 14
rU:dT 4 0.0008817 3.05468075 1.88974005 0.47619048 21
rU:dT 5 0.00410778 2.3863923 1.54626206 0.5 14
rU:dT 6 0.07361706 1.13302155 0.70215171 0.86666667 15
rU:dT 7 0.16550419 0.78119101 0.53695545 0.875 16
rU:dT 8 0.04597511 1.33747722 1.00685298 0.8 20
rU:dT 9 0.28169441 0.55022177 0.42019466 0.92857143 14
rU:dT 10 0.28631639 0.54315379 0.44159303 0.85714286 14
rU:dT 11 0.02820283 1.54970729 1.13709047 0.75 16
rU:dT 12 0.01700224 1.76949395 1.15715528 0.8 15
rU:dT 13 0.00155435 2.80845081 1.5461737 0.69230769 13
rU:dT 14 0.00029112 3.53592256 2.06771471 0.61904762 21
rU:dT 15 0.00111831 2.95143922 1.76440374 0.57894737 19
rU:dT 16 0.0274806 1.56097381 1.21176638 0.90909091 11
rU:dT 17 0.00103184 2.98638633 2.25820756 0.53333333 15
rU:dT 18 0.00661678 2.17935343 1.99648434 0.66666667 12
rU:dT 19 0.00164146 2.78477069 2.73553261 0.28571429 7
rU:dT 20 0.0008979 3.0467734 2.07660601 0.5625 16
rU:dG 1 0.14843535 0.82846266 0.49024731 0.85714286 14
rU:dG 2 0.03738723 1.42727677 0.74601111 0.85714286 14
rU:dG 3 0.0111067 1.95441477 1.68801805 0.42857143 14
rU:dG 4 0.001067 2.97183449 1.92215478 0.64705882 17
rU:dG 5 0.36961293 0.43225284 0.18289475 1 14
rU:dG 6 0.25518499 0.59314487 0.38604165 0.90909091 22
rU:dG 7 0.01409083 1.85106329 1.32933249 0.6875 16
rU:dG 8 0.32477259 0.48842063 0.14597373 1 14
rU:dG 9 0.21042115 0.67691062 0.41151964 0.92307692 13
rU:dG 10 0.0009474 3.02346518 2.31663498 0.53333333 15
rU:dG 11 0.00459101 2.33809151 1.47329815 0.66666667 15
rU:dG 12 0.43571287 0.36079961 0.27292464 0.94736842 19
rU:dG 13 0.05083961 1.29379777 0.81596013 0.78947368 19
rU:dG 14 9.07E-05 4.04237526 3.24747712 0.28571429 14
rU:dG 15 0.00061716 3.20960064 3.39051985 0.27272727 11
rU:dG 16 0.00260528 2.58414485 1.89433099 0.66666667 15
rU:dG 17 0.00634259 2.1977332 1.25513227 0.70588235 17
rU:dG 18 9.26E-05 4.03337903 2.20195081 0.42857143 21
rU:dG 19 4.34E-09 8.36294687 3.14355991 0.27586207 29
rU:dG 20 9.39E-11 10.0274471 3.67765569 0.09090909 22
rU:dC 1 0.08517903 1.06966733 0.05431666 0.95652174 23
rU:dC 2 0.09034172 1.04411165 0.6172904 0.84 25
rU:dC 3 0.00049296 3.30718836 1.79509813 0.5 18
rU:dC 4 0.00956505 2.01931275 1.9142246 0.625 16
rU:dC 5 0.00082937 3.08125356 1.6819354 0.64 25
rU:dC 6 0.00877226 2.05688852 1.83942383 0.57142857 14
rU:dC 7 0.00518102 2.28558461 1.34680362 0.58823529 17
rU:dC 8 0.05258048 1.27917549 1.28891011 0.73333333 15
rU:dC 9 0.00491869 2.30815056 1.53436525 0.61904762 21
rU:dC 10 0.00067548 3.17038851 2.05308466 0.5 18
rU:dC 11 9.73E-06 5.01190067 2.95861451 0.4 20
rU:dC 12 0.00052617 3.27887728 2.1715974 0.5 18
rU:dC 13 5.58E-08 7.25353645 2.93707954 0.26086957 23
rU:dC 14 8.60E-09 8.06525137 4.49826363 0 15
rU:dC 15 8.99E-12 11.0461321 4.05174928 0.05 20
rU:dC 16 1.70E-07 6.76925202 2.65078348 0.34615385 26
rU:dC 17 7.44E-08 7.12841974 3.7037368 0.11764706 17
rU:dC 18 1.98E-05 4.70367704 2.85422124 0.33333333 15
rU:dC 19 1.59E-06 5.79864373 3.12649619 0.25 16
rU:dC 20 7.68E-07 6.11473442 3.17271726 0.17647059 17
'''


def base_from_token(tok: str) -> str:
    # tok examples: 'rA', 'dG', 'rU' etc. Return standard base letter mapping U->T
    if len(tok) < 2:
        return tok
    b = tok[-1].upper()
    if b == 'U':
        return 'T'
    return b


def main():
    lines = [l.strip() for l in RAW.splitlines() if l.strip()]
    # collect per-substitution percent-active by position
    subs = {}  # (a,b) -> {pos: percent_active}
    pos_map = {i: [] for i in range(1, 21)}

    for line in lines:
        parts = line.split()
        if len(parts) < 6:
            continue
        mismatch = parts[0]
        pos = int(parts[1])
        percent_active = float(parts[5])

        if ':' not in mismatch:
            continue
        left, right = mismatch.split(':')
        a = base_from_token(left)
        b = base_from_token(right)
        key = (a, b)
        subs.setdefault(key, {})[pos] = percent_active
        pos_map.setdefault(pos, []).append(percent_active)

    # compute sub_weights as mean(1 - percent_active) across positions
    sub_weights = {}
    for (a, b), posvals in subs.items():
        vals = [1.0 - v for v in posvals.values()]
        if vals:
            sub_weights[f"{a}>{b}"] = sum(vals) / len(vals)

    # positional raw weight: mean(1 - percent_active) across substitutions at that position
    raw_pos = []
    for i in range(1, 21):
        vals = pos_map.get(i, [])
        if vals:
            raw = sum(1.0 - v for v in vals) / len(vals)
        else:
            raw = 0.0
        raw_pos.append(raw)

    # scale positional weights so max == 0.12
    max_raw = max(raw_pos) if raw_pos else 1.0
    scale = 0.12 / max_raw if max_raw > 0 else 1.0
    pos_weights = [round(v * scale, 6) for v in raw_pos]

    out = {"pos_weights": pos_weights, "sub_weights": sub_weights}
    p = Path(__file__).resolve().parents[1] / "crispr_check" / "data" / "cfd_published.json"
    p.parent.mkdir(parents=True, exist_ok=True)
    p.write_text(json.dumps(out, indent=2), encoding='utf-8')
    print('Wrote', p)


if __name__ == '__main__':
    main()
